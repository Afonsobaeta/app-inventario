<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Meta Tags para PWA (Progressive Web App) -->
    <meta name="theme-color" content="#4f46e5"/>
    <meta name="description" content="Aplicação de Gestão de Inventário com leitura de QR Code.">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.jpeg">

    <title>Gestão de Inventário por QR Code</title>
    
    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Biblioteca para ler QR Codes -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Bibliotecas para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Estilos personalizados para complementar o Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #qr-reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        /* Animação de loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sort-btn.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Contentor principal da aplicação -->
    <div id="app-container" class="max-w-4xl mx-auto">

        <!-- Ecrã de Carregamento / Autenticação -->
        <div id="loading-screen" class="text-center py-20 px-4">
            <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-message" class="mt-4 text-slate-500">A iniciar e a autenticar...</p>
        </div>
        
        <!-- DASHBOARD PRINCIPAL -->
        <div id="dashboard-view" class="p-4 md:p-6 hidden">
             <div class="max-w-md mx-auto flex flex-col gap-4">
                 <div class="flex justify-between items-center mb-4">
                     <div>
                         <h1 class="text-3xl font-bold text-slate-900">Inventário</h1>
                         <div id="user-info-dashboard" class="text-sm text-slate-500 mt-1">
                             Utilizador: <span id="user-name-display-dashboard" class="font-semibold"></span>
                         </div>
                     </div>
                     <button id="dashboard-definicoes-btn" class="w-12 h-12 flex items-center justify-center bg-white rounded-full shadow-md hover:bg-slate-100 transition text-slate-600">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226M15 2.25a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 15 20.25h-6A2.25 2.25 0 0 1 6.75 18V4.5a2.25 2.25 0 0 1 2.25-2.25h6.006ZM12 15.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z"/>
                         </svg>
                     </button>
                 </div>

                 <button id="dashboard-scan-btn" class="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg flex flex-col items-center justify-center aspect-square hover:bg-indigo-700 transition-transform transform hover:scale-105 duration-300">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mb-2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.776 48.776 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                     </svg>
                     <span class="font-semibold text-xl text-center">Registar Gasto</span>
                     <span class="text-sm text-indigo-200 text-center">Apontar câmara ao QR Code</span>
                 </button>

                 <button id="dashboard-movimentos-btn" class="bg-white p-5 rounded-2xl shadow-md w-full text-left hover:bg-slate-50 transition-colors duration-300 flex items-center space-x-4">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-slate-400">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" />
                     </svg>
                     <div>
                         <h3 class="font-semibold text-lg text-slate-800">Movimentos</h3>
                         <p class="text-sm text-slate-500">Ver e gerir histórico de gastos</p>
                     </div>
                 </button>

                 <div class="grid grid-cols-2 gap-4">
                     <button id="dashboard-artigos-btn" class="bg-white p-6 rounded-2xl shadow-md flex flex-col items-center justify-center aspect-square hover:bg-slate-50 transition-colors duration-300">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-slate-500">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
                          </svg>
                         <span class="font-semibold mt-2 text-slate-700">Artigos</span>
                     </button>
                     <button id="dashboard-obras-btn" class="bg-white p-6 rounded-2xl shadow-md flex flex-col items-center justify-center aspect-square hover:bg-slate-50 transition-colors duration-300">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-slate-500">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18h16.5a1.5 1.5 0 0 1 1.5 1.5v16.5a1.5 1.5 0 0 1-1.5 1.5H3.75a1.5 1.5 0 0 1-1.5-1.5V4.5a1.5 1.5 0 0 1 1.5-1.5Zm10.5 0v10.5m-3-3.75h6" />
                          </svg>
                         <span class="font-semibold mt-2 text-slate-700">Obras</span>
                     </button>
                 </div>
             </div>
        </div>

        <!-- VISTAS DE DETALHE -->
        <main id="detail-view" class="hidden p-4 md:p-6">
            <header class="mb-6 pb-4 border-b border-slate-200 flex items-center justify-between">
                <div class="flex items-center">
                    <button id="back-to-dashboard-btn" class="mr-4 p-2 rounded-full hover:bg-slate-200 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                        </svg>
                    </button>
                    <div>
                        <h1 id="detail-title" class="text-3xl font-bold text-slate-900"></h1>
                    </div>
                </div>
                <div id="movimentos-header-actions" class="hidden">
                    <button id="global-history-btn" class="p-2 rounded-full hover:bg-slate-200 transition text-slate-600" title="Ver Histórico Global de Movimentos">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0 0v14.25" /></svg>
                    </button>
                </div>
            </header>

            <div id="tab-content">
                <div id="movimentos-content" class="tab-pane fade-in">
                    <div class="mb-4">
                        <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Exportar para PDF
                        </button>
                    </div>
                    <div id="movimentos-list" class="space-y-3"></div>
                </div>
                <div id="movimentos-history-content" class="tab-pane hidden fade-in">
                    <div id="movimentos-history-list" class="space-y-3"></div>
                </div>
                <div id="artigos-content" class="tab-pane hidden fade-in">
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="add-artigo-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">+ Adicionar Artigo</button>
                        <button id="import-artigos-text-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            Importar Artigos
                        </button>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                        <div class="relative flex-grow">
                            <input type="search" id="search-artigos-input" placeholder="Pesquisar por nome ou referência..." class="w-full pl-10 pr-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-slate-600">Ordenar por:</span>
                            <button id="sort-artigos-nome-btn" data-sort="nome" class="sort-btn active bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-lg text-sm">Nome</button>
                            <button id="sort-artigos-ref-btn" data-sort="ref" class="sort-btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-lg text-sm">Referência</button>
                        </div>
                    </div>
                    <div id="artigos-list" class="space-y-3"></div>
                </div>
                <div id="obras-content" class="tab-pane hidden fade-in">
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button id="add-obra-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">+ Adicionar Obra</button>
                        <button id="import-obras-text-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            Importar Obras
                        </button>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                        <div class="relative flex-grow">
                            <input type="search" id="search-obras-input" placeholder="Pesquisar por nome, número ou cliente..." class="w-full pl-10 pr-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            </div>
                        </div>
                         <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-slate-600">Ordenar por:</span>
                            <button id="sort-obras-nome-btn" data-sort="nome" class="sort-btn active bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-lg text-sm">Nome</button>
                            <button id="sort-obras-numero-btn" data-sort="numero" class="sort-btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-lg text-sm">Número</button>
                        </div>
                    </div>
                    <div id="obras-list" class="space-y-3"></div>
                </div>
                 <div id="definicoes-content" class="tab-pane hidden fade-in">
                      <div class="bg-white p-6 rounded-xl shadow-md">
                          <h2 class="text-xl font-semibold mb-4">Definições do Utilizador</h2>
                          <div class="mb-4">
                              <label for="user-name-input" class="block text-sm font-medium text-slate-700 mb-1">O seu nome</label>
                              <input type="text" id="user-name-input" placeholder="Insira o seu nome" class="w-full md:w-1/2 px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                          </div>
                          <button id="save-settings-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg">Guardar Nome</button>
                      </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->
    <div id="qr-scanner-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative fade-in">
            <h3 class="text-xl font-semibold mb-2 text-center">Aponte a câmara para o QR Code</h3>
            <div id="qr-reader"></div>
            <p id="qr-scan-feedback" class="text-center text-sm mt-3 h-5 font-semibold"></p>
            <div class="mt-4 space-y-2">
                <button id="scan-now-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-indigo-700 transition disabled:bg-indigo-300" disabled>Confirmar Scan</button>
                <button id="scan-again-btn" class="w-full bg-slate-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-600 transition hidden">Voltar a Scannear</button>
            </div>
            <button id="close-scanner-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </div>
    </div>
    <div id="register-usage-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 fade-in">
            <h3 class="text-2xl font-bold mb-2">Registar Gasto de Material</h3>
            <form id="register-usage-form">
                <div class="mb-4 p-4 bg-slate-50 rounded-lg border">
                    <p class="text-sm text-slate-500">Artigo</p><p id="usage-artigo-nome" class="font-semibold text-lg"></p>
                    <p class="text-sm font-mono text-slate-400">Ref: <span id="usage-artigo-ref"></span></p>
                </div>
                <div class="mb-4"><label for="usage-quantidade" class="block text-sm font-medium text-slate-700 mb-1">Quantidade Usada</label><input type="number" id="usage-quantidade" min="1" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div class="mb-6 relative">
                    <label for="search-obra-select" class="block text-sm font-medium text-slate-700 mb-1">Destino (Obra)</label>
                    <input type="text" id="search-obra-select" placeholder="Pesquisar obra..." class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <div id="search-obra-dropdown" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-48 overflow-y-auto hidden"></div>
                    <input type="hidden" id="selected-obra-id">
                </div>
                <p id="usage-error-msg" class="text-red-500 text-sm mb-4 text-center h-5"></p>
                <div class="flex items-center justify-end space-x-3"><button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg">Confirmar</button></div>
            </form>
        </div>
    </div>
    <div id="edit-movement-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 fade-in">
            <h3 class="text-2xl font-bold mb-2">Editar Gasto de Material</h3>
            <form id="edit-movement-form">
                <input type="hidden" id="edit-movement-id">
                <div class="mb-4 p-4 bg-slate-50 rounded-lg border">
                    <p class="text-sm text-slate-500">Artigo</p>
                    <p id="edit-movement-artigo-nome" class="font-semibold text-lg"></p>
                    <p class="text-sm font-mono text-slate-400">Ref: <span id="edit-movement-artigo-ref"></span></p>
                </div>
                <div class="mb-4">
                    <label for="edit-movement-quantidade" class="block text-sm font-medium text-slate-700 mb-1">Quantidade Usada</label>
                    <input type="number" id="edit-movement-quantidade" min="1" required class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-6 relative">
                    <label for="edit-search-obra-select" class="block text-sm font-medium text-slate-700 mb-1">Destino (Obra)</label>
                    <input type="text" id="edit-search-obra-select" placeholder="Pesquisar nova obra..." class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div id="edit-search-obra-dropdown" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 max-h-48 overflow-y-auto hidden"></div>
                    <input type="hidden" id="edit-selected-obra-id">
                </div>
                <p id="edit-movement-error-msg" class="text-red-500 text-sm mb-4 text-center h-5"></p>
                <div class="flex items-center justify-end space-x-3"><button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg">Guardar Alterações</button></div>
            </form>
        </div>
    </div>
    <div id="generic-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 fade-in">
            <h3 id="confirm-title" class="text-xl font-semibold mb-2">Confirmar Ação</h3>
            <p id="confirm-message" class="text-slate-600 mb-6">Tem a certeza?</p>
            <div class="flex items-center justify-end space-x-3">
                <button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button type="button" id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

     <div id="add-artigo-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 fade-in">
             <h3 class="text-xl font-semibold mb-4">Adicionar Novo Artigo</h3>
             <form id="add-artigo-form">
                 <div class="mb-4"><label for="artigo-ref" class="block text-sm font-medium text-slate-700">Referência</label><input type="text" id="artigo-ref" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div class="mb-4"><label for="artigo-nome" class="block text-sm font-medium text-slate-700">Nome do Artigo</label><input type="text" id="artigo-nome" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div class="flex items-center justify-end space-x-3"><button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg">Guardar</button></div>
             </form>
         </div>
     </div>
     <div id="add-obra-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 fade-in">
             <h3 class="text-xl font-semibold mb-4">Adicionar Nova Obra</h3>
             <form id="add-obra-form">
                 <div class="mb-4"><label for="obra-numero" class="block text-sm font-medium text-slate-700">Nº da Obra</p><input type="text" id="obra-numero" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div class="mb-4"><label for="obra-nome" class="block text-sm font-medium text-slate-700">Nome da Obra</p><input type="text" id="obra-nome" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div class="mb-4"><label for="obra-cliente" class="block text-sm font-medium text-slate-700">Cliente</p><input type="text" id="obra-cliente" required class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></div>
                 <div class="flex items-center justify-end space-x-3"><button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Guardar</button></div>
             </form>
         </div>
     </div>
     <div id="import-artigos-text-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 fade-in max-h-[90vh] flex flex-col">
             <h3 class="text-xl font-semibold mb-4">Importar Artigos de Texto</h3>
             <div id="artigos-text-import-step1">
                 <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 rounded-md">
                     <p class="font-bold">Instruções</p>
                     <p>Cole a sua lista de artigos na caixa abaixo. Cada linha deve conter um artigo no seguinte formato, separado por ponto e vírgula:</p>
                     <p class="font-mono bg-blue-100 p-2 rounded mt-2 text-sm">REFERENCIA;NOME DO ARTIGO</p>
                 </div>
                 <textarea id="artigos-text-input-area" class="w-full h-40 p-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="01.01.0001;Artigo A&#10;01.01.0002;Artigo B"></textarea>
                  <button type="button" id="process-artigos-text-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Processar Texto</button>
             </div>
             <div id="artigos-text-import-step2" class="hidden">
                 <h4 class="font-semibold mb-2">Pré-visualização dos Artigos</h4>
                 <div id="artigos-text-preview-table" class="overflow-y-auto max-h-64 border rounded-lg"></div>
                 <div id="artigos-text-import-summary" class="mt-4 text-sm font-medium"></div>
             </div>
             <div class="mt-auto pt-4 flex items-center justify-end space-x-3">
                 <button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                 <button type="button" id="confirm-import-artigos-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-5 rounded-lg hidden">Confirmar Importação</button>
             </div>
         </div>
     </div>
     <div id="import-obras-text-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 fade-in max-h-[90vh] flex flex-col">
             <h3 class="text-xl font-semibold mb-4">Importar Obras de Texto</h3>
             <div id="obras-text-import-step1">
                 <div class="bg-teal-50 border-l-4 border-teal-500 text-teal-700 p-4 mb-4 rounded-md">
                     <p class="font-bold">Instruções</p>
                     <p>Cole a sua lista de obras na caixa abaixo, uma por linha, no formato:</p>
                      <p class="font-mono bg-teal-100 p-2 rounded mt-2 text-sm">Nº DA OBRA;NOME DA OBRA;CLIENTE</p>
                 </div>
                 <textarea id="obras-text-input-area" class="w-full h-40 p-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="2024-01;Obra do Centro;Cliente A&#10;2024-02;Remodelação da Loja;Cliente B"></textarea>
                  <button type="button" id="process-obras-text-btn" class="mt-4 w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-5 rounded-lg">Processar Texto</button>
             </div>
             <div id="obras-text-import-step2" class="hidden">
                 <h4 class="font-semibold mb-2">Pré-visualização das Obras</h4>
                 <div id="obras-text-preview-table" class="overflow-y-auto max-h-64 border rounded-lg"></div>
                 <div id="obras-text-import-summary" class="mt-4 text-sm font-medium"></div>
             </div>
             <div class="mt-auto pt-4 flex items-center justify-end space-x-3">
                 <button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                 <button type="button" id="confirm-import-obras-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-5 rounded-lg hidden">Confirmar Importação</button>
             </div>
         </div>
     </div>
     <div id="export-pdf-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
         <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 fade-in">
             <h3 class="text-xl font-semibold mb-4">Exportar Movimentos para PDF</h3>
             <div class="space-y-4">
                 <div>
                     <label for="filter-ref" class="block text-sm font-medium text-slate-700">Filtrar por Referência (opcional)</label>
                     <input type="text" id="filter-ref" placeholder="Deixe em branco para todos" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                         <label for="filter-start-date" class="block text-sm font-medium text-slate-700">Data de Início (opcional)</label>
                         <input type="date" id="filter-start-date" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                     </div>
                     <div>
                         <label for="filter-end-date" class="block text-sm font-medium text-slate-700">Data de Fim (opcional)</label>
                         <input type="date" id="filter-end-date" class="mt-1 w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm">
                     </div>
                 </div>
             </div>
             <div class="mt-6 flex items-center justify-end space-x-3">
                 <button type="button" class="close-modal-btn bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                 <button type="button" id="confirm-export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg">Gerar PDF</button>
             </div>
         </div>
     </div>
    <div id="notification-modal" class="fixed bottom-5 right-5 z-50 hidden"><div id="notification-content" class="p-4 rounded-lg shadow-lg text-white font-semibold"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, getDocs, onSnapshot, query, where, writeBatch, serverTimestamp, setDoc, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- FUNÇÕES GLOBAIS --- //
        const showNotification = (message, type = 'success') => {
            const notificationContent = document.getElementById('notification-content');
            const notificationModal = document.getElementById('notification-modal');
            notificationContent.textContent = message;
            notificationContent.className = 'p-4 rounded-lg shadow-lg text-white font-semibold ';
            notificationContent.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            notificationModal.classList.remove('hidden');
            setTimeout(() => { notificationModal.classList.add('hidden'); }, 4000);
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'Data indisponível';
            return new Date(timestamp.seconds * 1000).toLocaleString('pt-PT', { dateStyle: 'medium', timeStyle: 'short' });
        };
        
        // --- INICIALIZAÇÃO DA APP ---
        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? JSON.parse(__firebase_config) 
                : {
                    apiKey: "AIzaSyBOWoJRYCC7CYBvtieuS8tJ5XkTKfUHDuQ",
                    authDomain: "inventario-ded36.firebaseapp.com",
                    projectId: "inventario-ded36",
                    storageBucket: "inventario-ded36.firebasestorage.app",
                    messagingSenderId: "381290321142",
                    appId: "1:381290321142:web:e8ca2b55437e74deeb88d7"
                };
            
            const appId = firebaseConfig.appId || 'default-inventory-app';

            let app, db, auth, userId, userName = 'Anónimo', html5QrCode;
            let allArtigos = [], allObras = [], allMovimentos = [];
            let parsedArtigos = [], parsedObras = [];
            let sortArtigosBy = 'nome', sortObrasBy = 'nome';
            
            const artigosPath = `artifacts/${appId}/public/data/artigos`;
            const obrasPath = `artifacts/${appId}/public/data/obras`;
            const movimentosPath = `artifacts/${appId}/public/data/movimentos`;
            const movimentosHistoryPath = `artifacts/${appId}/public/data/movimentos_history`;
            const usersPath = `artifacts/${appId}/users`;

            // --- Seletores de DOM ---
            const loadingScreen = document.getElementById('loading-screen');
            const dashboardView = document.getElementById('dashboard-view');
            const detailView = document.getElementById('detail-view');
            const detailTitle = document.getElementById('detail-title');
            const movimentosHeaderActions = document.getElementById('movimentos-header-actions');
            const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
            
            const tabPanes = { 
                movimentos: document.getElementById('movimentos-content'), 
                artigos: document.getElementById('artigos-content'), 
                obras: document.getElementById('obras-content'), 
                definicoes: document.getElementById('definicoes-content'),
                history: document.getElementById('movimentos-history-content')
            };
            const lists = { 
                movimentos: document.getElementById('movimentos-list'), 
                artigos: document.getElementById('artigos-list'), 
                obras: document.getElementById('obras-list'),
                history: document.getElementById('movimentos-history-list')
            };
            
            const searchArtigosInput = document.getElementById('search-artigos-input');
            const sortArtigosNomeBtn = document.getElementById('sort-artigos-nome-btn');
            const sortArtigosRefBtn = document.getElementById('sort-artigos-ref-btn');
            const searchObrasInput = document.getElementById('search-obras-input');
            const sortObrasNomeBtn = document.getElementById('sort-obras-nome-btn');
            const sortObrasNumeroBtn = document.getElementById('sort-obras-numero-btn');
            const searchObraSelect = document.getElementById('search-obra-select');
            const searchObraDropdown = document.getElementById('search-obra-dropdown');
            const selectedObraIdInput = document.getElementById('selected-obra-id');
            const editSearchObraSelect = document.getElementById('edit-search-obra-select');
            const editSearchObraDropdown = document.getElementById('edit-search-obra-dropdown');
            const editSelectedObraIdInput = document.getElementById('edit-selected-obra-id');
            
            const registerUsageModal = document.getElementById('register-usage-modal');
            const registerUsageForm = document.getElementById('register-usage-form');
            const editMovementModal = document.getElementById('edit-movement-modal');
            const editMovementForm = document.getElementById('edit-movement-form');
            const genericConfirmModal = document.getElementById('generic-confirm-modal');
            const confirmActionBtn = document.getElementById('confirm-action-btn');

            let currentScannedArticle = null;
            let confirmCallback = null;
            let lastDetectedQrCode = null;

            // --- Funções de Navegação e UI ---
            const showDetailView = (viewName, title) => {
                dashboardView.classList.add('hidden');
                detailView.classList.remove('hidden');
                detailTitle.textContent = title;
                Object.values(tabPanes).forEach(pane => pane.classList.add('hidden'));
                tabPanes[viewName].classList.remove('hidden');
                movimentosHeaderActions.classList.toggle('hidden', viewName !== 'movimentos' && viewName !== 'history');
            };

            const showDashboard = () => {
                detailView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
            };

            const showConfirmModal = (title, message, onConfirm) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                confirmCallback = onConfirm;
                genericConfirmModal.classList.remove('hidden');
            };
            
            // --- Funções de Renderização e Filtragem ---
            const renderArtigos = (artigos) => {
                lists.artigos.innerHTML = '';
                if (artigos.length === 0) { lists.artigos.innerHTML = `<p class="text-slate-500 text-center py-5">Nenhum artigo encontrado.</p>`; return; }
                artigos.forEach(artigo => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-800">${artigo.nome}</p>
                            <p class="text-sm text-slate-500 font-mono">${artigo.referencia}</p>
                        </div>
                        <button data-id="${artigo.id}" class="delete-artigo-btn p-1 text-slate-400 hover:text-red-600 transition-colors" title="Eliminar Artigo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    lists.artigos.appendChild(el);
                });
            };
            
            const filterAndRenderArtigos = () => {
                const searchTerm = searchArtigosInput.value.toLowerCase();
                let filtered = allArtigos.filter(art => art.nome.toLowerCase().includes(searchTerm) || art.referencia.toLowerCase().includes(searchTerm));
                
                const sortFn = sortArtigosBy === 'nome' 
                    ? (a, b) => a.nome.localeCompare(b.nome)
                    : (a, b) => a.referencia.localeCompare(b.referencia);
                filtered.sort(sortFn);
                renderArtigos(filtered);
            };

            const renderObras = (obras) => {
                lists.obras.innerHTML = '';
                if (obras.length === 0) { lists.obras.innerHTML = `<p class="text-slate-500 text-center py-5">Nenhuma obra encontrada.</p>`; return; }
                obras.forEach(obra => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center';
                    el.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-slate-800">${obra.nome}</p>
                            <p class="text-sm text-slate-500">Cliente: ${obra.cliente || 'N/A'}</p>
                            <p class="text-sm font-mono text-slate-400">${obra.numero || ''}</p>
                        </div>
                        <button data-id="${obra.id}" class="delete-obra-btn p-1 text-slate-400 hover:text-red-600 transition-colors" title="Eliminar Obra">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    lists.obras.appendChild(el);
                });
            };

            const filterAndRenderObras = () => {
                const searchTerm = searchObrasInput.value.toLowerCase();
                let filtered = allObras.filter(obra => obra.nome.toLowerCase().includes(searchTerm) || (obra.numero && obra.numero.toLowerCase().includes(searchTerm)) || (obra.cliente && obra.cliente.toLowerCase().includes(searchTerm)));
                
                const sortFn = sortObrasBy === 'nome' 
                    ? (a, b) => a.nome.localeCompare(b.nome)
                    : (a, b) => new Intl.Collator('pt-PT', { numeric: true }).compare(a.numero, b.numero);
                filtered.sort(sortFn);
                renderObras(filtered);
            };
            
            const renderMovimentos = () => {
                lists.movimentos.innerHTML = '';
                if (allMovimentos.length === 0) { lists.movimentos.innerHTML = `<p class="text-slate-500 text-center py-5">Nenhum movimento registado.</p>`; return; }
                
                allMovimentos.forEach(mov => {
                    const artigo = allArtigos.find(a => a.id === mov.artigo_id) || { nome: 'Artigo Apagado', referencia: '-' };
                    const obra = allObras.find(o => o.id === mov.obra_id) || { nome: 'Obra Apagada' };
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200';
                    el.innerHTML = `
                        <div class="grid grid-cols-3 gap-4 items-center">
                            <div>
                                <p class="font-bold text-slate-800">${artigo.nome}</p>
                                <p class="text-sm font-mono text-slate-500">${artigo.referencia}</p>
                                <p class="text-sm text-slate-500">${obra.nome || 'Obra não encontrada'}</p>
                            </div>
                            <div class="text-center"><p class="text-red-600 font-bold text-xl">-${mov.quantidade_gasta}</p></div>
                            <div class="text-right text-sm text-slate-500">
                                <p>${formatDate(mov.data_movimento)}</p>
                                <p class="text-xs truncate">por: <span class="font-semibold">${mov.userName || 'Anónimo'}</span></p>
                                <div class="mt-2 flex justify-end space-x-2">
                                    <button data-id="${mov.id}" class="edit-movement-btn p-1 text-slate-400 hover:text-indigo-600 transition-colors" title="Editar">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <button data-id="${mov.id}" class="delete-movement-btn p-1 text-slate-400 hover:text-red-600 transition-colors" title="Eliminar">
                                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    lists.movimentos.appendChild(el);
                });
            };

            const renderGlobalHistory = async () => {
                lists.history.innerHTML = '<div class="spinner mx-auto"></div>';
                const q = query(collection(db, movimentosHistoryPath), orderBy('timestamp', 'desc'));
                try {
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        lists.history.innerHTML = '<p class="text-slate-500 text-center py-5">Nenhum histórico de alterações encontrado.</p>';
                        return;
                    }
                    lists.history.innerHTML = '';
                    snapshot.forEach(doc => {
                        const historyData = doc.data();
                        const el = document.createElement('div');
                        el.className = 'bg-white p-4 rounded-lg shadow-sm border border-slate-200';
                        const artigoInfo = historyData.data?.artigo_nome || 'Artigo Desconhecido';
                        
                        let content = `<div class="flex justify-between items-center text-sm mb-2"><span class="font-semibold text-slate-800">${historyData.userName || 'Anónimo'}</span><span class="text-slate-500">${formatDate(historyData.timestamp)}</span></div>`;
                        let details = '';
                        switch(historyData.action) {
                            case 'created':
                                details = `<span class="font-semibold text-green-600">CRIOU:</span> ${historyData.data.quantidade_gasta}x <strong>${artigoInfo}</strong>`;
                                break;
                            case 'edited':
                                const oldObra = allObras.find(o => o.id === historyData.oldData.obra_id) || {nome: 'N/A'};
                                const newObra = allObras.find(o => o.id === historyData.newData.obra_id) || {nome: 'N/A'};
                                let changes = [];
                                if (historyData.oldData.quantidade_gasta !== historyData.newData.quantidade_gasta) changes.push(`Qtd: ${historyData.oldData.quantidade_gasta} ➞ ${historyData.newData.quantidade_gasta}`);
                                if (historyData.oldData.obra_id !== historyData.newData.obra_id) changes.push(`Obra: "${oldObra.nome}" ➞ "${newObra.nome}"`);
                                details = `<span class="font-semibold text-blue-600">EDITOU:</span> ${changes.join(', ')} no gasto de <strong>${artigoInfo}</strong>`;
                                break;
                            case 'deleted':
                                details = `<span class="font-semibold text-red-600">ELIMINOU:</span> Gasto de ${historyData.data.quantidade_gasta}x <strong>${artigoInfo}</strong>`;
                                break;
                        }
                        el.innerHTML = content + `<p class="text-sm">${details}</p>`;
                        lists.history.appendChild(el);
                    });
                } catch(error) {
                    console.error("Erro ao carregar histórico global:", error);
                    lists.history.innerHTML = '<p class="text-red-500 text-center py-5">Erro ao carregar o histórico.</p>';
                }
            };

            // --- Funções de Lógica de Negócio (Scanner e Firestore) ---
            const onScanSuccess = (decodedText, decodedResult) => {
                if (lastDetectedQrCode) return; 

                lastDetectedQrCode = decodedText;
                
                const feedback = document.getElementById('qr-scan-feedback');
                feedback.textContent = `Código detetado: ${decodedText}`;
                feedback.classList.remove('text-red-500');
                feedback.classList.add('text-green-600');
                
                document.getElementById('scan-now-btn').disabled = false;
                document.getElementById('scan-again-btn').classList.remove('hidden');
            };
            
            const onScanFailure = (error) => { /* Ignorar */ };

            const startScanner = () => {
                lastDetectedQrCode = null;
                const scanNowBtn = document.getElementById('scan-now-btn');
                const scanAgainBtn = document.getElementById('scan-again-btn');
                const feedback = document.getElementById('qr-scan-feedback');

                scanNowBtn.disabled = true;
                scanAgainBtn.classList.add('hidden');
                feedback.textContent = '';
                feedback.classList.remove('text-green-600');
                feedback.classList.add('text-red-500');

                document.getElementById('qr-scanner-modal').classList.remove('hidden');
                
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    onScanFailure
                ).catch((err) => {
                    feedback.textContent = "Não foi possível iniciar a câmara.";
                    console.error("Erro ao iniciar o leitor de QR code", err);
                });
            };

            const stopScanner = () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => {
                        console.warn("Aviso ao parar o leitor de QR code.", err);
                    });
                }
                document.getElementById('qr-scanner-modal').classList.add('hidden');
            };
            
            const confirmScan = () => {
                if (lastDetectedQrCode) {
                    stopScanner();
                    processScannedReference(lastDetectedQrCode);
                }
            };

            const rescan = () => {
                lastDetectedQrCode = null;
                const scanNowBtn = document.getElementById('scan-now-btn');
                const scanAgainBtn = document.getElementById('scan-again-btn');
                const feedback = document.getElementById('qr-scan-feedback');

                scanNowBtn.disabled = true;
                scanAgainBtn.classList.add('hidden');
                feedback.textContent = 'A procurar código...';
                feedback.classList.remove('text-green-600');
            };

            const processScannedReference = async (ref) => {
                const q = query(collection(db, artigosPath), where("referencia", "==", ref));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { showNotification(`Artigo com referência "${ref}" não encontrado.`, 'error'); return; }
                currentScannedArticle = { id: querySnapshot.docs[0].id, ...querySnapshot.docs[0].data() };
                document.getElementById('usage-artigo-nome').textContent = currentScannedArticle.nome;
                document.getElementById('usage-artigo-ref').textContent = currentScannedArticle.referencia;
                registerUsageForm.reset();
                registerUsageModal.classList.remove('hidden');
            };

            const handleRegisterUsage = async (e) => {
                e.preventDefault();
                const quantidade = parseInt(document.getElementById('usage-quantidade').value, 10);
                const obraId = selectedObraIdInput.value;
                if (isNaN(quantidade) || quantidade <= 0 || !obraId) { showNotification('Dados inválidos. Verifique a quantidade e a obra.', 'error'); return; }
                
                const newMovementData = {
                    artigo_id: currentScannedArticle.id,
                    artigo_nome: currentScannedArticle.nome,
                    obra_id: obraId,
                    quantidade_gasta: quantidade,
                    userId: userId,
                    userName: userName,
                    data_movimento: serverTimestamp()
                };
                const newDocRef = await addDoc(collection(db, movimentosPath), newMovementData);
                await addDoc(collection(db, movimentosHistoryPath), { action: 'created', movementId: newDocRef.id, data: newMovementData, userName, userId, timestamp: serverTimestamp() });
                
                registerUsageModal.classList.add('hidden');
                showNotification('Gasto registado com sucesso!', 'success');
            };

            const handleUpdateMovement = async (e) => {
                e.preventDefault();
                const movementId = document.getElementById('edit-movement-id').value;
                const newQuantidade = parseInt(document.getElementById('edit-movement-quantidade').value, 10);
                const newObraId = editSelectedObraIdInput.value;
                if (isNaN(newQuantidade) || newQuantidade <= 0 || !newObraId) { showNotification('Dados inválidos.', 'error'); return; }
                
                const movementDocRef = doc(db, movimentosPath, movementId);
                const docSnap = await getDoc(movementDocRef);
                if (!docSnap.exists()) { showNotification('Erro: Movimento não encontrado.', 'error'); return; }
                
                const oldData = docSnap.data();
                const newData = { quantidade_gasta: newQuantidade, obra_id: newObraId };
                await updateDoc(movementDocRef, newData);
                await addDoc(collection(db, movimentosHistoryPath), { action: 'edited', movementId, oldData: { quantidade_gasta: oldData.quantidade_gasta, obra_id: oldData.obra_id }, newData, userName, userId, timestamp: serverTimestamp() });
                
                editMovementModal.classList.add('hidden');
                showNotification('Movimento atualizado!', 'success');
            };
            
            const handleDeleteMovement = async (movementId) => {
                const movementDocRef = doc(db, movimentosPath, movementId);
                const docSnap = await getDoc(movementDocRef);
                if (docSnap.exists()) {
                    await addDoc(collection(db, movimentosHistoryPath), { action: 'deleted', movementId: movementId, data: docSnap.data(), userName, userId, timestamp: serverTimestamp() });
                    await deleteDoc(movementDocRef);
                    showNotification('Movimento eliminado!', 'success');
                }
            };

            const handleDeleteArtigo = async (artigoId) => {
                const q = query(collection(db, movimentosPath), where("artigo_id", "==", artigoId));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    showNotification('Este artigo não pode ser eliminado pois está associado a movimentos.', 'error');
                    return;
                }
                await deleteDoc(doc(db, artigosPath, artigoId));
                showNotification('Artigo eliminado com sucesso.', 'success');
            };

            const handleDeleteObra = async (obraId) => {
                const q = query(collection(db, movimentosPath), where("obra_id", "==", obraId));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    showNotification('Esta obra não pode ser eliminada pois está associada a movimentos.', 'error');
                    return;
                }
                await deleteDoc(doc(db, obrasPath, obraId));
                showNotification('Obra eliminada com sucesso.', 'success');
            };
            
            const handleAddArtigo = async (e) => {
                e.preventDefault();
                const ref = document.getElementById('artigo-ref').value.trim();
                const nome = document.getElementById('artigo-nome').value.trim();
                if (!ref || !nome) return showNotification('Preencha todos os campos.', 'error');
                try {
                    const q = query(collection(db, artigosPath), where("referencia", "==", ref));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) return showNotification(`A referência "${ref}" já existe.`, 'error');
                    await addDoc(collection(db, artigosPath), { referencia: ref, nome: nome, data_criacao: serverTimestamp() });
                    document.getElementById('add-artigo-modal').classList.add('hidden');
                    showNotification('Artigo adicionado com sucesso!', 'success');
                } catch (error) { console.error("Erro ao adicionar artigo: ", error); showNotification("Ocorreu um erro ao adicionar o artigo.", 'error'); }
            };

            const handleAddObra = async (e) => {
                e.preventDefault();
                const numero = document.getElementById('obra-numero').value.trim();
                const nome = document.getElementById('obra-nome').value.trim();
                const cliente = document.getElementById('obra-cliente').value.trim();
                if (!numero || !nome || !cliente) return showNotification('Por favor, preencha todos os campos.', 'error');
                try {
                    const q = query(collection(db, obrasPath), where("numero", "==", numero));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) return showNotification(`O número de obra "${numero}" já existe.`, 'error');
                    await addDoc(collection(db, obrasPath), { numero: numero, nome: nome, cliente: cliente, data_criacao: serverTimestamp() });
                    document.getElementById('add-obra-modal').classList.add('hidden');
                    showNotification('Obra adicionada com sucesso!', 'success');
                } catch (error) { console.error("Erro ao adicionar obra: ", error); showNotification("Ocorreu um erro ao adicionar a obra.", 'error'); }
            };

            const importItems = async (parsedItems, collectionPath, uniqueKey) => {
                const q = query(collection(db, collectionPath));
                const querySnapshot = await getDocs(q);
                const existingKeys = new Set(querySnapshot.docs.map(doc => doc.data()[uniqueKey]));
                const batch = writeBatch(db);
                let importedCount = 0;
                parsedItems.forEach(item => {
                    if (!existingKeys.has(item[uniqueKey])) {
                        const newItemRef = doc(collection(db, collectionPath));
                        batch.set(newItemRef, {...item, data_criacao: serverTimestamp()});
                        importedCount++;
                        existingKeys.add(item[uniqueKey]);
                    }
                });
                if (importedCount > 0) await batch.commit();
                showNotification(`${importedCount} itens importados. ${parsedItems.length - importedCount} ignorados (já existiam).`, 'success');
            };

            // --- Inicialização e Event Listeners ---
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                html5QrCode = new Html5Qrcode("qr-reader");

                // --- Navegação ---
                document.getElementById('dashboard-scan-btn').addEventListener('click', startScanner);
                document.getElementById('dashboard-movimentos-btn').addEventListener('click', () => showDetailView('movimentos', 'Movimentos'));
                document.getElementById('dashboard-artigos-btn').addEventListener('click', () => showDetailView('artigos', 'Artigos'));
                document.getElementById('dashboard-obras-btn').addEventListener('click', () => showDetailView('obras', 'Obras'));
                document.getElementById('dashboard-definicoes-btn').addEventListener('click', () => showDetailView('definicoes', 'Definições'));
                document.getElementById('global-history-btn').addEventListener('click', () => { renderGlobalHistory(); showDetailView('history', 'Histórico de Movimentos'); });
                backToDashboardBtn.addEventListener('click', showDashboard);

                // --- Modais ---
                document.querySelectorAll('.close-modal-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modal = e.target.closest('.modal-backdrop');
                        if (modal.id === 'qr-scanner-modal') {
                            stopScanner();
                        } else {
                            modal.classList.add('hidden');
                        }
                    });
                });
                document.getElementById('close-scanner-btn').addEventListener('click', stopScanner);
                document.getElementById('scan-now-btn').addEventListener('click', confirmScan);
                document.getElementById('scan-again-btn').addEventListener('click', rescan);

                confirmActionBtn.addEventListener('click', () => {
                    if (confirmCallback) confirmCallback();
                    genericConfirmModal.classList.add('hidden');
                });
                
                // --- Forms ---
                registerUsageForm.addEventListener('submit', handleRegisterUsage);
                editMovementForm.addEventListener('submit', handleUpdateMovement);
                document.getElementById('add-artigo-form').addEventListener('submit', handleAddArtigo);
                document.getElementById('add-obra-form').addEventListener('submit', handleAddObra);
                document.getElementById('save-settings-btn').addEventListener('click', async () => {
                    const newName = document.getElementById('user-name-input').value.trim();
                    if (newName && userId) {
                        await setDoc(doc(db, usersPath, userId), { name: newName }, { merge: true });
                        userName = newName;
                        document.getElementById('user-name-display-dashboard').textContent = newName;
                        showNotification("Nome guardado com sucesso!", "success");
                    }
                });


                // --- Importação de Artigos ---
                document.getElementById('add-artigo-btn').addEventListener('click', () => document.getElementById('add-artigo-modal').classList.remove('hidden'));
                document.getElementById('import-artigos-text-btn').addEventListener('click', () => document.getElementById('import-artigos-text-modal').classList.remove('hidden'));
                document.getElementById('process-artigos-text-btn').addEventListener('click', () => {
                    const lines = document.getElementById('artigos-text-input-area').value.split('\n');
                    parsedArtigos = lines.map(line => {
                        const [referencia, nome] = line.split(';').map(s => s.trim());
                        return (referencia && nome) ? { referencia, nome } : null;
                    }).filter(Boolean);
                    document.getElementById('confirm-import-artigos-btn').classList.remove('hidden');
                });
                document.getElementById('confirm-import-artigos-btn').addEventListener('click', () => importItems(parsedArtigos, artigosPath, 'referencia'));

                // --- Importação de Obras ---
                document.getElementById('add-obra-btn').addEventListener('click', () => document.getElementById('add-obra-modal').classList.remove('hidden'));
                document.getElementById('import-obras-text-btn').addEventListener('click', () => document.getElementById('import-obras-text-modal').classList.remove('hidden'));
                document.getElementById('process-obras-text-btn').addEventListener('click', () => {
                     const lines = document.getElementById('obras-text-input-area').value.split('\n');
                     parsedObras = lines.map(line => {
                         const [numero, nome, cliente] = line.split(';').map(s => s.trim());
                         return (numero && nome && cliente) ? { numero, nome, cliente } : null;
                    }).filter(Boolean);
                     document.getElementById('confirm-import-obras-btn').classList.remove('hidden');
                });
                document.getElementById('confirm-import-obras-btn').addEventListener('click', () => importItems(parsedObras, obrasPath, 'numero'));
                
                // --- Ações nas Listas ---
                const setupListActions = (listElement, editClass, deleteClass, editHandler, deleteHandler) => {
                    listElement.addEventListener('click', (e) => {
                        const button = e.target.closest('button');
                        if (!button) return;
                        const id = button.dataset.id;
                        if (editClass && button.classList.contains(editClass)) {
                            if (editHandler) editHandler(id);
                        } else if (deleteClass && button.classList.contains(deleteClass)) {
                            if (deleteHandler) deleteHandler(id);
                        }
                    });
                };

                setupListActions(lists.movimentos, 'edit-movement-btn', 'delete-movement-btn', 
                    (movementId) => { // Edit Handler
                        const mov = allMovimentos.find(m => m.id === movementId);
                        const artigo = allArtigos.find(a => a.id === mov.artigo_id);
                        const obra = allObras.find(o => o.id === mov.obra_id);
                        document.getElementById('edit-movement-id').value = mov.id;
                        document.getElementById('edit-movement-artigo-nome').textContent = artigo?.nome || 'N/A';
                        document.getElementById('edit-movement-artigo-ref').textContent = artigo?.referencia || '-';
                        document.getElementById('edit-movement-quantidade').value = mov.quantidade_gasta;
                        editSearchObraSelect.value = obra ? `${obra.numero} - ${obra.nome}` : '';
                        editSelectedObraIdInput.value = obra?.id || '';
                        editMovementModal.classList.remove('hidden');
                    },
                    (movementId) => { // Delete Handler
                        showConfirmModal('Eliminar Movimento', 'Tem a certeza que deseja eliminar este movimento?', () => handleDeleteMovement(movementId));
                    }
                );

                setupListActions(lists.artigos, null, 'delete-artigo-btn', null, 
                    (artigoId) => showConfirmModal('Eliminar Artigo', 'Tem a certeza que deseja eliminar este artigo?', () => handleDeleteArtigo(artigoId))
                );

                setupListActions(lists.obras, null, 'delete-obra-btn', null, 
                    (obraId) => showConfirmModal('Eliminar Obra', 'Tem a certeza que deseja eliminar esta obra?', () => handleDeleteObra(obraId))
                );

                
                // --- EXPORTAÇÃO PARA PDF ---

// Seleciona os elementos do DOM necessários para a exportação
const exportPdfBtn = document.getElementById('export-pdf-btn');
const exportPdfModal = document.getElementById('export-pdf-modal');
const confirmExportPdfBtn = document.getElementById('confirm-export-pdf-btn');
const filterRefInput = document.getElementById('filter-ref');
const filterStartDateInput = document.getElementById('filter-start-date');
const filterEndDateInput = document.getElementById('filter-end-date');

// Adiciona um evento ao botão principal para abrir o modal de filtros
exportPdfBtn.addEventListener('click', () => {
    // Limpa os filtros sempre que o modal é aberto
    filterRefInput.value = '';
    filterStartDateInput.value = '';
    filterEndDateInput.value = '';
    exportPdfModal.classList.remove('hidden');
});


// Adiciona o evento de clique ao botão "Gerar PDF" dentro do modal (VERSÃO CORRIGIDA)
confirmExportPdfBtn.addEventListener('click', () => {
    try {
        // As bibliotecas jsPDF são carregadas globalmente, acedemo-las através do objeto window
        const { jsPDF } = window.jspdf;

        // --- LINHA CORRIGIDA ---
        // A verificação agora confirma se a função 'autoTable' foi adicionada ao jsPDF
        if (!jsPDF || typeof jsPDF.API.autoTable !== 'function') {
            showNotification('Erro: A biblioteca para gerar PDF (jsPDF ou autoTable) não foi carregada.', 'error');
            return;
        }
        // --- FIM DA CORREÇÃO ---

        // 1. Criar o documento PDF (agora é criado no início)
        const doc = new jsPDF();

        // 2. Obter os valores dos filtros do modal
        const filterRef = filterRefInput.value.toLowerCase().trim();
        const startDate = filterStartDateInput.value ? new Date(filterStartDateInput.value) : null;
        const endDate = filterEndDateInput.value ? new Date(filterEndDateInput.value) : null;

        if (startDate) startDate.setHours(0, 0, 0, 0);
        if (endDate) endDate.setHours(23, 59, 59, 999);

        // 3. Filtrar a lista de movimentos com base nos filtros
        const filteredMovimentos = allMovimentos.filter(mov => {
            const artigo = allArtigos.find(a => a.id === mov.artigo_id);
            if (!artigo) return false;

            const refMatch = filterRef ? artigo.referencia.toLowerCase().includes(filterRef) : true;
            const movDate = new Date(mov.data_movimento.seconds * 1000);
            const startDateMatch = startDate ? movDate >= startDate : true;
            const endDateMatch = endDate ? movDate <= endDate : true;

            return refMatch && startDateMatch && endDateMatch;
        });

        if (filteredMovimentos.length === 0) {
            showNotification('Nenhum movimento encontrado para os filtros selecionados.', 'error');
            return;
        }

        // 4. Preparar os dados para a tabela
        const head = [['Data', 'Referência', 'Artigo', 'Qtd.', 'Obra', 'Utilizador']];
        const body = filteredMovimentos.map(mov => {
            const artigo = allArtigos.find(a => a.id === mov.artigo_id) || {};
            const obra = allObras.find(o => o.id === mov.obra_id) || {};
            return [
                formatDate(mov.data_movimento),
                artigo.referencia || 'N/A',
                artigo.nome || 'Artigo Apagado',
                mov.quantidade_gasta,
                obra.nome || 'Obra Apagada',
                mov.userName || 'Anónimo'
            ];
        });

        // Adiciona um título ao documento
        doc.setFontSize(18);
        doc.text('Relatório de Movimentos de Inventário', 14, 20);
        doc.setFontSize(11);
        doc.setTextColor(100);

        // 5. Utiliza o plugin autoTable para criar a tabela
        doc.autoTable({
            startY: 30,
            head: head,
            body: body,
            theme: 'striped',
            headStyles: { fillColor: [79, 70, 229] }
        });

        // 6. Guardar o PDF com um nome de ficheiro dinâmico
        const today = new Date().toISOString().slice(0, 10);
        doc.save(`relatorio_movimentos_${today}.pdf`);

        // 7. Fechar o modal e mostrar uma notificação de sucesso
        exportPdfModal.classList.add('hidden');
        showNotification('PDF gerado com sucesso!', 'success');

    } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        showNotification('Ocorreu um erro ao gerar o PDF.', 'error');
    }
});
                
                // --- Pesquisa de Obras nos Modais ---
                const setupObraSearch = (searchInput, dropdown, selectedIdInput) => {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        if (!searchTerm) { dropdown.classList.add('hidden'); return; }
                        const filteredObras = allObras.filter(obra => obra.nome.toLowerCase().includes(searchTerm) || (obra.numero && obra.numero.toLowerCase().includes(searchTerm)) );
                        dropdown.innerHTML = '';
                        if (filteredObras.length > 0) {
                            filteredObras.forEach(obra => {
                                const item = document.createElement('div');
                                item.className = 'p-2 hover:bg-indigo-100 cursor-pointer';
                                item.textContent = `${obra.numero} - ${obra.nome}`;
                                item.addEventListener('click', () => {
                                    searchInput.value = item.textContent;
                                    if(selectedIdInput) {
                                        selectedIdInput.value = obra.id;
                                    }
                                    dropdown.classList.add('hidden');
                                });
                                dropdown.appendChild(item);
                            });
                            dropdown.classList.remove('hidden');
                        } else { dropdown.classList.add('hidden'); }
                    });
                };

                setupObraSearch(searchObraSelect, searchObraDropdown, selectedObraIdInput);
                setupObraSearch(editSearchObraSelect, editSearchObraDropdown, editSelectedObraIdInput);
                
                // --- Listeners de Filtros e Ordenação ---
                searchArtigosInput.addEventListener('input', filterAndRenderArtigos);
                sortArtigosNomeBtn.addEventListener('click', () => { sortArtigosBy = 'nome'; filterAndRenderArtigos(); });
                sortArtigosRefBtn.addEventListener('click', () => { sortArtigosBy = 'ref'; filterAndRenderArtigos(); });
                searchObrasInput.addEventListener('input', filterAndRenderObras);
                sortObrasNomeBtn.addEventListener('click', () => { sortObrasBy = 'nome'; filterAndRenderObras(); });
                sortObrasNumeroBtn.addEventListener('click', () => { sortObrasBy = 'numero'; filterAndRenderObras(); });

                // --- Autenticação e Listeners do Firestore ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const userDocRef = doc(db, usersPath, userId);
                        try {
                            const userDocSnap = await getDoc(userDocRef);
                            if (userDocSnap.exists() && userDocSnap.data().name) userName = userDocSnap.data().name;
                        } catch (error) { console.warn("Erro ao carregar perfil."); }
                        document.getElementById('user-name-display-dashboard').textContent = userName;
                        document.getElementById('user-name-input').value = userName;
                        loadingScreen.classList.add('hidden');
                        dashboardView.classList.remove('hidden');

                        onSnapshot(query(collection(db, artigosPath)), snap => { allArtigos = snap.docs.map(d => ({id:d.id, ...d.data()})); filterAndRenderArtigos(); renderMovimentos(); });
                        onSnapshot(query(collection(db, obrasPath)), snap => { allObras = snap.docs.map(d => ({id:d.id, ...d.data()})); filterAndRenderObras(); renderMovimentos(); });
                        onSnapshot(query(collection(db, movimentosPath), orderBy('data_movimento', 'desc')), snap => { allMovimentos = snap.docs.map(d => ({id:d.id, ...d.data()})); renderMovimentos(); });
                    }
                });
                await signInAnonymously(auth);

            } catch (error) { 
                console.error("Erro fatal na inicialização: ", error); 
                document.getElementById('loading-message').textContent = 'Ocorreu um erro crítico.';
            }
        });
    </script>
</body>
</html>
